<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Stats</title>

	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
		  integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
		  integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
			integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
			crossorigin="anonymous"></script>

	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>

<div class="container-fluid">
	<div class="row">
		<div class="col-xs-8">
			<h1>Player: <strong id="player-name"></strong></h1>
		</div>
		<div class="col-xs-4">
			<div id="games-summary"></div>
		</div>
	</div>
	<div class="row">
		<div class="col-xs-12">
			<h2>Rank history</h2>
			<div id="rank-history"></div>
		</div>
	</div>
	<div class="row">
		<div class="col-xs-6">
			<h2>Last Games</h2>
			<div id="last-games"></div>
		</div>
		<div class="col-xs-6">
			<h2>Records</h2>
			<div id="records"></div>
		</div>
	</div>
</div>

<script>
	google.charts.load( 'current', { 'packages': [ 'corechart' ] } );
	google.charts.setOnLoadCallback( function() {
		showPlayerStats( getPlayer() );
	} );

	function showPlayerStats( player ) {
		var responseText = jQuery.ajax( {
			url: '/stats/get?player=' + player,
			dataType: 'json',
			async: false
		} ).responseText;

		var data = JSON.parse( responseText );

		console.log( data );

		jQuery( '#player-name' ).html( player );

		drawChart( data.rankHistory );

		drawGamesChart( data.records );

		renderLastGames( data.lastGames, player );

		renderRecords( data.records, player );
	}

	function renderRecords( records, player ) {
		var table = jQuery( '<table class="table table-striped table-condensed">' );
		var tbody = jQuery( '<tbody>' );
		table.append( tbody );

		const strongPlayer = '<strong>' + player + '</strong>';

		makeRow( 'Humiliations', records.humiliations.wins );
		makeRow( 'Humiliated', records.humiliations.lost );
		makeRow( 'Rank Gain on Lost times', records.gainRankOnLost );
		makeRow( 'Rank Gain on Lost max', records.gainRankOnLostMax );
		makeRow( 'Rank Lost on Win times', records.lostRankOnWin );
		makeRow( 'Rank Lost on Win max', records.lostRankOnWinMax );
		makeRow( 'No sense games', records.noRankChange );
		makeRow( 'Max points gain', '<strong>' + records.pointsGain + '</strong> ' +
				renderMatch( records.pointsGainMatch ) );
		makeRow( 'Max points lost', '<strong>' + records.pointsLost + '</strong> ' +
				renderMatch( records.pointsLostMatch ) );
		makeRow( 'Max wins series', records.seriesWins );
		makeRow( 'Max loses series', records.seriesLooses );
		makeRow( 'Max rank', records.rankMax );
		makeRow( 'Min rank', records.rankMin );

		function renderMatch( match ) {
			return (match.blue + ' ' + match.score + ' ' + match.red).replace( player, strongPlayer );
		}

		function makeRow( a, b ) {
			var row = jQuery( '<tr>' );
			row.append( jQuery( '<td>' ).html( a ) );
			row.append( jQuery( '<td>' ).html( b ) );

			tbody.append( row );
		}

		table.appendTo( '#records' );
	}

	function renderLastGames( lastGames, player ) {
		var table = jQuery( '<table class="table table-striped table-condensed">' );
		var tbody = jQuery( '<tbody>' );
		var strongPlayer = '<strong>' + player + '</strong>';

		for ( var lastGame of lastGames ) {
			var row = jQuery( '<tr>' );

			row.append( jQuery( '<td class="text-right">' ).html( lastGame.red.replace( player, strongPlayer ) ) );
			row.append( jQuery( '<td class="text-center">' ).html( lastGame.score ) );
			row.append( jQuery( '<td class="text-left">' ).html( lastGame.blue.replace( player, strongPlayer ) ) );
			row.append( jQuery( '<td class="text-right">' ).html( lastGame.rankChange ) );

			if ( lastGame.rankChange > 0 ) {
				row.addClass( 'success' );
			}

			if ( lastGame.rankChange < 0 ) {
				row.addClass( 'danger' );
			}

			if ( lastGame.rankChange === 0 ) {
				row.addClass( 'warning' );
			}

			tbody.append( row );
		}

		table.append( tbody );
		table.appendTo( '#last-games' );
	}

	function drawChart( history ) {
		var data = new google.visualization.DataTable();

		data.addColumn( 'number', 'Game' );
		data.addColumn( 'number', 'Rank' );

		let game = 1;

		const mapped = history.map( function( entry ) {
			return [ game++, entry[ 1 ] ];
		} );

		data.addRows( mapped );

		var options = {
			curveType: 'none',
			vAxis: {
				title: 'Rank',
				baseline: 2000,
				baselineColor: 'black'
			},
			hAxis: {
				title: 'Game'
			}
		};

		var chart = new google.visualization.LineChart( document.getElementById( 'rank-history' ) );

		chart.draw( data, options );
	}

	function drawGamesChart( records ) {
		var data = new google.visualization.DataTable();

		data.addColumn( 'string', 'What' );
		data.addColumn( 'number', 'Number' );

		data.addRows( [
			[ 'Looses', records.looses ],
			[ 'Wins', records.wins ]
		] );

		var chart = new google.visualization.PieChart( document.getElementById( 'games-summary' ) );

		chart.draw( data, {
			is3D: true,
			slices: {
				0: { color: 'red' },
				1: { color: 'green' }
			}
		} );
	}

	function getPlayer() {
		var queryString = location.search.substring( 1 );
		var options = queryString.split( '=' );

		if ( options[ 0 ] !== 'player' ) {
			alert( 'player value must be first' );
		}

		return options[ 1 ];
	}
</script>

</body>
</html>
